#!/bin/bash

# Create log of traffic generated by all containers
# Then reset the counter
# Do this periodically as it is lost on reboot
# and it's  more reliable than periodically saving iptables and
# parsing the log
#
# Author: Amro Diab
# Date: 03/04/2009

source /etc/profile
set -e

# Call from root's crontab
hostname=`hostname`

trafficlog="/var/amrox/scripts/iptables/$hostname-traffic.log"
for i in `cat /var/amrox/scripts/iptables/$hostname-all-ips.txt`; do
  echo -n `date "+%Y-%m-%d %H:%M:%S"` >> $trafficlog
  echo -n " $i " >> $trafficlog
  echo `/sbin/iptables -nvx -L FORWARD | grep " $i " | tr -s [:blank:] | \
    cut -d' ' -f3| awk '{sum+=$1} END {print sum;}'`| \
    grep -v " 0$" >> $trafficlog
 done

 # reset the counter
 iptables -Z
 # update the iptables rules if there is a any change in containers
 /var/amrox/scripts/iptables/vz-iptables-create-rules

#put into db
 /var/amrox/scripts/iptables/mysql.pl $PLAT
 rm -f $trafficlog

